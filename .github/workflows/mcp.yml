name: MCP Package CI

on:
  push:
    paths:
      - "packages/mcp/**"
      - ".github/workflows/mcp.yml"
  pull_request:
    paths:
      - "packages/mcp/**"
      - ".github/workflows/mcp.yml"

jobs:
  typecheck:
    name: typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - run: npm ci
      # ðŸ‘‡ Build memory so its dist + d.ts exist for TS resolver
      - run: npm run build:memory
      # ðŸ‘‡ Now typecheck MCP (no emit)
      - run: npm run typecheck:mcp

  validate-phase-3-2:
    name: validate-phase-3-2
    runs-on: ubuntu-latest
    needs: [typecheck]
    env:
      BUILD_SHA: ${{ github.sha }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - run: npm ci
      - run: npm run validate:phase3_2 --workspace=@prompted-forge/mcp

  tests:
    name: tests (${{ matrix.impl }})
    runs-on: ubuntu-latest
    needs: [typecheck, validate-phase-3-2]
    strategy:
      matrix: { impl: [stub, full] }
    env:
      PF_MEMORY_IMPL: ${{ matrix.impl }}
      PF_ENFORCE_FULL_FALLBACK: "true"
      BUILD_SHA: ${{ github.sha }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - run: npm ci
      - run: npm run build:memory
      - run: npm test --workspace=@prompted-forge/mcp -- --ci --reporters=default
