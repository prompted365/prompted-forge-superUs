name: MCP Package CI

on:
  push:
    paths:
      - "packages/mcp/**"
      - ".github/workflows/mcp.yml"
  pull_request:
    paths:
      - "packages/mcp/**"
      - ".github/workflows/mcp.yml"

jobs:
  typecheck:
    name: typecheck
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/mcp
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - run: npm ci
      - run: npm run typecheck

  validate-phase-3-2:
    name: validate-phase-3-2
    runs-on: ubuntu-latest
    needs: [typecheck]
    env:
      BUILD_SHA: ${{ github.sha }}
    defaults:
      run:
        working-directory: packages/mcp
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - run: npm ci
      - run: npm run validate:phase3_2

  tests:
    name: tests (${{ matrix.impl }})
    runs-on: ubuntu-latest
    needs: [typecheck, validate-phase-3-2]
    strategy:
      matrix: { impl: [stub, full] }
    defaults:
      run:
        working-directory: packages/mcp
    env:
      PF_MEMORY_IMPL: ${{ matrix.impl }}
      PF_ENFORCE_FULL_FALLBACK: "true"
      BUILD_SHA: ${{ github.sha }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - run: npm ci
      - run: npm test -- --ci --reporters=default
